!function(a){"use strict";var b=a.fabric||(a.fabric={});b.Image.filters.WoodFilter=b.util.createClass(b.Image.filters.BaseFilter,{type:"WoodFilter",initialize:function(a){a=a||{},this.invert=a.invert||!1,this.threshold=a.threshold||30,this.distance=a.distance||20,this.color=a.color||"#000000",this.opacity="undefined"!=typeof a.opacity?a.opacity:new b.Color(this.color).getAlpha(),this.opaque=a.opaque,this.matrix=a.matrix||[0,0,0,0,1,0,0,0,0]},applyTo:function(a){var c,d,e,f,g,h,i,j=this,k=(a.getContext("2d"),document.createElement("canvas")),l=k.getContext("2d"),m=this.matrix,n=this.invert,o=this.threshold,p=this.distance,q=255-o,r=Math.round(Math.sqrt(m.length)),s=Math.floor(r/2),t=[],u=this.opaque?1:0,v=2,w=a.height/v,x=w,y=a.width*a.height*4,z=y/v,A=a.width,B=1;return d=new b.Color(this.color).getSource(),e=d[0]*this.opacity,f=d[1]*this.opacity,g=d[2]*this.opacity,h=1-this.opacity,k.width=a.width,k.height=a.height,l.drawImage(a,0,0),"undefined"!=typeof Promise?new Promise(function(b,d){for(var o=0;v>o;o++){Worker.create=function(a){var b=a.toString(),c=new Blob(["'use strict';\nself.onmessage ="+b],{type:"text/javascript"});return window.URL.createObjectURL(c)};var y=Worker.create(function(a){var b,c,d=a.data.data,e=d.data,f=a.data.invert,g=a.data.limit,h=a.data.distance,i=a.data.tintR,k=a.data.tintG,l=a.data.tintB,m=a.data.alpha1,n=a.data.halfSide,o=a.data.alphaFac,p=a.data.side,q=a.data.weights,r=a.data.w,s=a.data.h,t=Math.abs,u=a.data.length,v=a.data.index;for(b=0;u>b;b+=4)c=(e[b]+e[b+1]+e[b+2])/3,e[b]=c,e[b+1]=c,e[b+2]=c;for(b=0;u>b;b+=4)f&&(e[b]=255-e[b],e[b+1]=255-e[b+1],e[b+2]=255-e[b+2]);for(b=0;u>b;b+=4){var w=e[b],x=e[b+1],y=e[b+2];w>g&&x>g&&y>g&&t(w-x)<h&&t(w-y)<h&&t(x-y)<h&&(e[b+3]=1)}for(b=0;u>b;b+=4){var w=e[b],x=e[b+1],y=e[b+2];e[b]=i+w*m,e[b+1]=k+x*m,e[b+2]=l+y*m}for(var z=0;s>z;z++)for(var A=0;r>A;A++){for(var B=4*(z*r+A),C=0,w=0,x=0,y=0,D=0;p>D;D++)for(var E=0;p>E;E++){var F=z+D-n,G=A+E-n;if(!(0>F||F>s||0>G||G>r)){var H=4*(F*r+G),I=q[D*p+E];w+=e[H]*I,x+=e[H+1]*I,y+=e[H+2]*I,C+=e[H+3]*I}}e[B]=w,e[B+1]=x,e[B+2]=y,e[B+3]=C+o*(255-C)}j.postMessage({result:d,index:v}),j.close()}),C=new Worker(y);C.onmessage=function(a){var c=a.data.result,d=a.data.index;if(console.info("web worker-"+d+" finished"),t.splice(d,0,{index:d,data:c,blocks:w*d}),B===v){for(i=0;i<t.length;i++)l.putImageData(t[i].data,0,t[i].blocks);b(k)}B++},C.onerror=function(){d(Error("Worker failed"))},c=l.getImageData(0,w*o,a.width,w),C.postMessage({data:c,index:o,length:z,invert:n,limit:q,distance:p,tintR:e,tintG:f,tintB:g,alpha1:h,halfSide:s,alphaFac:u,side:r,weights:m,w:A,h:x})}}):void b.warn("Promises are not support in your browser")}}),b.Image.filters.WoodFilter.fromObject=function(a){return new b.Image.filters.WoodFilter(a)}}("undefined"!=typeof exports?exports:this);